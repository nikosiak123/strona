<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zarządzaj rezerwacją - Zakręcone Korepetycje</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .edit-container { display: flex; gap: 2rem; max-width: 1200px; margin: 2.5rem auto; }
        .details-panel, .calendar-panel { background-color: var(--container-bg-color); border-radius: 16px; box-shadow: 0 8px 24px var(--shadow-color); padding: 2.5rem; }
        .details-panel { flex: 1; }
        .calendar-panel { flex: 2; }
        .details-panel h2 { margin-top: 0; }
        .details-item { margin-bottom: 1rem; font-size: 1.1rem; }
        .details-item strong { color: var(--text-dark); }
        .details-item span { color: var(--text-medium); }
        .action-buttons { margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s ease; }
        .btn-danger { background-color: #DC3545; color: white; }
        .btn-danger:hover { background-color: #C82333; }
        .btn:disabled { background-color: #E0E0E0; color: var(--text-light); cursor: not-allowed; }
        .time-limit-info { margin-top: 1rem; font-size: 0.9rem; color: var(--text-light); }
    </style>
</head>
<body>
    <header><h1>Zarządzaj rezerwacją</h1></header>

    <main id="loadingState" class="container" style="text-align: center; padding: 4rem;">
        <h2>Ładowanie danych rezerwacji...</h2>
    </main>

    <main id="editState" class="edit-container" style="display: none;">
        <aside class="details-panel">
            <h2>Twoja rezerwacja</h2>
            <div id="reservationDetails"></div>
            <div class="action-buttons">
                <button id="rescheduleButton" class="btn" disabled>Zmień termin</button>
                <button id="cancelButton" class="btn btn-danger" disabled>Odwołaj lekcję</button>
            </div>
            <p id="timeLimitInfo" class="time-limit-info"></p>
        </aside>

        <section class="calendar-panel">
            <h2>Wybierz nowy termin</h2>
            <p>Aktualnie wybrany: <strong id="newSelectionInfo">Brak</strong></p>
            <div id="calendar-container">
                <p>Ładowanie dostępnych terminów...</p>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');

            const loadingState = document.getElementById('loadingState');
            const editState = document.getElementById('editState');
            const detailsElement = document.getElementById('reservationDetails');
            const timeLimitInfo = document.getElementById('timeLimitInfo');
            const cancelButton = document.getElementById('cancelButton');
            const rescheduleButton = document.getElementById('rescheduleButton');
            const newSelectionInfo = document.getElementById('newSelectionInfo');
            const calendarContainer = document.getElementById('calendar-container');

            const monthNames = ["Sty", "Lut", "Mar", "Kwi", "Maj", "Cze", "Lip", "Sie", "Wrz", "Paź", "Lis", "Gru"];
            const dayNamesFull = ["Niedziela", "Poniedziałek", "Wtorek", "Środa", "Czwartek", "Piątek", "Sobota"];
            const workingHoursStart = 8, workingHoursEnd = 22;

            let availableSlotsData = {};
            let currentWeekStart = getMonday(new Date());
            let newSelectedDate = null;
            let newSelectedTime = null;
            let newSelectedSlotId = null;

            if (!token) {
                loadingState.innerHTML = '<h2>Błąd: Brak identyfikatora rezerwacji.</h2>';
                return;
            }

            try {
                const details = await fetchReservationDetails(token);
                displayReservationDetails(details);
                loadingState.style.display = 'none';
                editState.style.display = 'flex';
                await fetchAvailableSlots(currentWeekStart);
            } catch (error) {
                loadingState.innerHTML = `<h2>Błąd: ${error.message}</h2>`;
            }

            cancelButton.addEventListener('click', async () => {
                if (confirm("Czy na pewno chcesz odwołać tę lekcję? Tej operacji nie można cofnąć.")) {
                    try {
                        const response = await fetch('https://zakrecone-korepetycje-api-467795448922.europe-central2.run.app/api/cancel-reservation', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ token: token })
                        });
                        if (!response.ok) throw new Error((await response.json()).message || "Nie udało się odwołać lekcji.");
                        alert("Lekcja została odwołana.");
                        window.location.href = 'index.html'; // Or redirect to dashboard
                    } catch (error) {
                        alert(`Błąd: ${error.message}`);
                    }
                }
            });
            
            rescheduleButton.addEventListener('click', async () => {
                if (!newSelectedDate || !newSelectedTime) {
                    alert("Proszę wybrać nowy termin z kalendarza.");
                    return;
                }
                try {
                    const response = await fetch('https://zakrecone-korepetycje-api-467795448922.europe-central2.run.app/api/reschedule-reservation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: token, newDate: newSelectedDate, newTime: newSelectedTime })
                    });
                    if (!response.ok) throw new Error((await response.json()).message || "Nie udało się zmienić terminu.");
                    alert((await response.json()).message);
                    window.location.reload();
                } catch (error) {
                    alert(`Błąd: ${error.message}`);
                }
            });

            async function fetchReservationDetails(token) {
                const response = await fetch(`https://zakrecone-korepetycje-api-467795448922.europe-central2.run.app/api/get-reservation-details?token=${token}`);
                if (!response.ok) throw new Error((await response.json()).message || "Nie można załadować danych rezerwacji.");
                return await response.json();
            }

            function displayReservationDetails(details) {
                detailsElement.innerHTML = `
                    <div class="details-item"><strong>Uczeń:</strong> <span>${details.student}</span></div>
                    <div class="details-item"><strong>Korepetytor:</strong> <span>${details.tutor}</span></div>
                    <div class="details-item"><strong>Termin:</strong> <span>${details.date} o ${details.time}</span></div>
                `;
                if (details.isCancellationAllowed) {
                    cancelButton.disabled = false;
                    timeLimitInfo.textContent = "Możesz odwołać lub zmienić termin do 12 godzin przed rozpoczęciem zajęć.";
                } else {
                    timeLimitInfo.textContent = "Pozostało mniej niż 12 godzin do rozpoczęcia zajęć. Nie można już zarządzać tym terminem.";
                }
            }

            function selectSlot(slotId, element, date, time) {
                const prevSelected = document.querySelector('.time-block.selected');
                if (prevSelected) prevSelected.classList.remove('selected');
                element.classList.add('selected');
                
                newSelectedSlotId = slotId;
                newSelectedDate = date;
                newSelectedTime = time;
                
                newSelectionInfo.textContent = `${date} o ${time}`;
                if (!cancelButton.disabled) {
                    rescheduleButton.disabled = false;
                }
            }
            
            function getMonday(d) {
                d = new Date(d);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(d.setDate(diff));
            }
            function getFormattedDate(date) {
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const dd = String(date.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            }

            async function fetchAvailableSlots(startDate) {
                try {
                    const response = await fetch(`https://zakrecone-korepetycje-api-467795448922.europe-central2.run.app/api/get-schedule?startDate=${getFormattedDate(startDate)}`);
                    if (!response.ok) throw new Error('Błąd pobierania danych z serwera');
                    const scheduleFromApi = await response.json();
                    const processedData = {};
                    scheduleFromApi.forEach(slot => {
                        const { date, time, tutor } = slot;
                        if (!processedData[date]) processedData[date] = [];
                        processedData[date].push({ id: `block_${date}_${time.replace(':', '')}_${tutor.replace(' ', '_')}`, time, tutor });
                    });
                    availableSlotsData = processedData;
                    generateTimeSlotCalendar(startDate);
                } catch (error) {
                    calendarContainer.innerHTML = `<p style="color: red;">${error.message}</p>`;
                }
            }
            
            function generateTimeSlotCalendar(startDate) {
                calendarContainer.innerHTML = '';
                const daysInWeek = Array.from({length: 7}, (_, i) => {
                    const d = new Date(startDate);
                    d.setDate(d.getDate() + i);
                    return d;
                });
                
                const table = document.createElement('table');
                table.className = 'calendar-grid-table';
                let headerRow = '<tr><th class="time-label">Godzina</th>';
                daysInWeek.forEach(day => {
                    headerRow += `<th>${dayNamesFull[day.getDay()]}<br>${String(day.getDate()).padStart(2, '0')} ${monthNames[day.getMonth()]}</th>`;
                });
                headerRow += '</tr>';
                table.createTHead().innerHTML = headerRow;

                const tbody = table.createTBody();
                for (let h = workingHoursStart; h < workingHoursEnd; h++) {
                    const row = tbody.insertRow();
                    row.insertCell().outerHTML = `<td class="time-label">${String(h).padStart(2, '0')}:00</td>`;
                    daysInWeek.forEach(day => {
                        const cell = row.insertCell();
                        const formattedDate = getFormattedDate(day);
                        const blockStartTime = `${String(h).padStart(2, '0')}:00`;
                        const blockId = `block_${formattedDate}_${blockStartTime.replace(':', '')}`;
                        const matchingSlot = (availableSlotsData[formattedDate] || []).find(slot => slot.time === blockStartTime);
                        const blockDateTime = new Date(`${formattedDate}T${blockStartTime}:00`);
                        
                        const block = document.createElement('div');
                        block.className = 'time-block';
                        block.dataset.slotId = blockId;
                        block.dataset.date = formattedDate;
                        block.dataset.time = blockStartTime;
                        
                        if (blockDateTime < new Date()) {
                            block.classList.add('past');
                            block.textContent = matchingSlot ? blockStartTime : '';
                        } else if (matchingSlot) {
                            block.textContent = blockStartTime;
                            block.addEventListener('click', () => selectSlot(blockId, block, formattedDate, blockStartTime));
                        } else {
                            block.classList.add('disabled');
                        }
                        cell.appendChild(block);
                    });
                }
                calendarContainer.appendChild(table);
            }

            function changeWeek(days) {
                currentWeekStart.setDate(currentWeekStart.getDate() + days);
                newSelectedSlotId = null;
                newSelectedDate = null;
                newSelectedTime = null;
                newSelectionInfo.textContent = 'Brak';
                rescheduleButton.disabled = true;
                fetchAvailableSlots(currentWeekStart);
            }
        });
    </script>
</body>
</html>